{# imports/templates/imports/register_imports.html #}
{% extends 'core/base.html' %}
{% load static %}
{% block title %}{% if import_obj %}Edit Import {{ import_obj.import_code }}{% else %}Register Import{% endif %}{% endblock %}

{% block content %}
<style>
  .section { border: 1px solid rgba(0,0,0,.08); border-radius: .6rem; padding: 1rem; margin-bottom: 1rem; }
  .section-title { font-size: .8rem; text-transform: uppercase; letter-spacing: .06em; color: #6c757d; margin-bottom: .75rem; }
  .sticky-actions { position: sticky; bottom: -1px; background: #fff; border-top: 1px solid rgba(0,0,0,.08); padding: .75rem 1rem; z-index: 2; }
  .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,.06); }
  .muted { color: #6c757d; }
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container py-4">
  <div class="card border-0 card-shadow mx-auto" style="max-width: 900px;">
    <div class="card-header bg-white border-0 pt-3 pb-0">
      <h1 class="h4 mb-1">
        {% if import_obj %}
          Edit Import {{ import_obj.import_code }}
        {% else %}
          Register Import
        {% endif %}
      </h1>
      <p class="muted small mb-3">
        Enter shipment and commercial details to {% if import_obj %}update{% else %}create{% endif %} an import record.
      </p>
    </div>

    <div class="card-body pt-3">
      {% if created_import %}
        <div class="alert alert-success mb-3" role="alert">
          Import <strong>{{ created_import.import_code }}</strong> was created successfully.
        </div>
      {% endif %}

      {% with fd=form_data %}
      <form method="post" class="needs-validation" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" id="form_action" value="save_import">

        {# IMPORTANT: keep lines_json exactly as sent back from the view #}
        <input type="hidden"
               name="lines_json"
               id="lines_json"
               value="{{ lines_json|default:''|escape }}">

        {# IMPORTANT: preserve packages_json on re-render #}
        <input type="hidden"
               name="packages_json"
               id="packages_json"
               value="{{ packages_json|default:''|escape }}">

        {# Safe JSON blobs for JS (avoid HTML escaping issues) #}
        {{ lines_json|default:"[]"|json_script:"lines-json" }}
        {{ packages_json|default:"[]"|json_script:"packages-initial" }}

        {# ðŸ”¹ SECTIONS AS PARTIALS #}
        {% include "imports/partials/basic_details.html" %}
        {% include "imports/partials/financials.html" %}
        {% include "imports/partials/logistics.html" %}
        {% include "imports/partials/import_lines.html" %}
        {% include "imports/partials/weight_dimensions.html" %}
        {% include "imports/partials/charges.html" %}
        {% include "imports/partials/customs_declaration.html" %}
        {% include "imports/partials/notes.html" %}
        {% include "imports/partials/sticky_actions.html" %}
      </form>
      {% endwith %}
    </div>
  </div>
</div>

<script>

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form.needs-validation');
    if (form) {
      form.addEventListener('submit', function () {
        if (window._serializePackages) window._serializePackages();
      }, true); // capture = true ensures it runs early
    }
  });


  (function () {
    'use strict';

    // -------------------------
    // Helpers
    // -------------------------
    const parseNum = (s) => {
      if (s === '' || s == null) return null;
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    };

    function upperize(el) {
      if (!el) return;
      el.addEventListener('input', function () {
        const p = this.selectionStart;
        this.value = this.value.toUpperCase();
        try { this.setSelectionRange(p, p); } catch (e) {}
      });
    }

    // -------------------------
    // Select2
    // -------------------------
    function initSelect2() {
      const $vendor = $('#vendor_name');
      if ($vendor.length) {
        $vendor.select2({
          width: '100%',
          placeholder: 'Select vendor',
          allowClear: true
        });
        $vendor.on('change', function () {
          this.setCustomValidity(this.value ? '' : ' ');
        });
      }

      const $country = $('#id_exporter_country');
      if ($country.length) {
        $country.select2({
          width: '100%',
          placeholder: 'Exporter Country',
          allowClear: true
        });
      }
    }

    // -------------------------
    // Packages UI
    // -------------------------
    // UI toggle ONLY changes labels; server converts imperial->cm/kg and stores cm/kg
    let currentUnitSystem = 'metric'; // metric = cm/kg, imperial = in/lbs

    function updateUnitLabels() {
      const unitLabel = document.getElementById('unitLabel');
      const lenLabels = document.querySelectorAll('.len-label');
      const widLabels = document.querySelectorAll('.wid-label');
      const heiLabels = document.querySelectorAll('.hei-label');
      const gwLabels  = document.querySelectorAll('.gw-label');

      if (currentUnitSystem === 'imperial') {
        if (unitLabel) unitLabel.textContent = 'in / lbs';
        lenLabels.forEach(l => l.textContent = 'Length (in)');
        widLabels.forEach(l => l.textContent = 'Width (in)');
        heiLabels.forEach(l => l.textContent = 'Height (in)');
        gwLabels.forEach(l  => l.textContent = 'Gross Weight (lbs)');
      } else {
        if (unitLabel) unitLabel.textContent = 'cm / kg';
        lenLabels.forEach(l => l.textContent = 'Length (cm)');
        widLabels.forEach(l => l.textContent = 'Width (cm)');
        heiLabels.forEach(l => l.textContent = 'Height (cm)');
        gwLabels.forEach(l  => l.textContent = 'Gross Weight (kg)');
      }
    }

    function createPackageRow(pkg = {}) {
      const tr = document.createElement('tr');

      const type = (pkg.type || '').toUpperCase();
      const length = (pkg.length != null) ? pkg.length : '';
      const width  = (pkg.width != null) ? pkg.width : '';
      const height = (pkg.height != null) ? pkg.height : '';
      const gw     = (pkg.gross_weight != null) ? pkg.gross_weight : '';

      tr.innerHTML = `
        <td>
          <select class="form-select form-select-sm pkg-type">
            <option value=""></option>
            <option value="BOX" ${type === 'BOX' ? 'selected' : ''}>Box</option>
            <option value="PALLET" ${type === 'PALLET' ? 'selected' : ''}>Pallet</option>
            <option value="SKID" ${type === 'SKID' ? 'selected' : ''}>Skid</option>
            <option value="ROLL" ${type === 'ROLL' ? 'selected' : ''}>Roll</option>
            <option value="ENVELOPE" ${type === 'ENVELOPE' ? 'selected' : ''}>Envelope</option>
          </select>
        </td>
        <td><input type="number" min="0" step="0.01" class="form-control form-control-sm pkg-length" value="${length}" inputmode="decimal"></td>
        <td><input type="number" min="0" step="0.01" class="form-control form-control-sm pkg-width"  value="${width}"  inputmode="decimal"></td>
        <td><input type="number" min="0" step="0.01" class="form-control form-control-sm pkg-height" value="${height}" inputmode="decimal"></td>
        <td><input type="number" min="0" step="0.01" class="form-control form-control-sm pkg-gw"     value="${gw}"     inputmode="decimal"></td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-pkg" aria-label="Remove package">&times;</button>
        </td>
      `;
      return tr;
    }

    function addPackageRow(pkg = {}) {
      const tbody = document.getElementById('packagesBody');
      if (!tbody) return;
      tbody.appendChild(createPackageRow(pkg));
    }

    // âœ… FIX: hydrate ONLY if packages-initial contains rows
    function hydratePackagesFromJSONIfAny() {
      const tbody = document.getElementById('packagesBody');
      const initialEl = document.getElementById('packages-initial');
      if (!tbody || !initialEl) return;

      let initial = [];
      try {
        initial = JSON.parse(initialEl.textContent || '[]');
      } catch (e) {
        initial = [];
      }

      // If we have JSON rows -> use them (clear tbody)
      if (Array.isArray(initial) && initial.length) {
        tbody.innerHTML = '';
        initial.forEach(p => addPackageRow(p));
      }
      // else: do nothing (keep server-rendered rows)
    }

    // NOTE:
    // We do NOT convert numbers in the browser.
    // We just tag unit_system, server converts and stores cm/kg.
    function serializePackages() {
      const tbody = document.getElementById('packagesBody');
      const hidden = document.getElementById('packages_json');
      if (!tbody || !hidden) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));

      const data = rows.map(row => {
        const type = (row.querySelector('.pkg-type')?.value || '').toUpperCase();
        const length = parseNum(row.querySelector('.pkg-length')?.value);
        const width  = parseNum(row.querySelector('.pkg-width')?.value);
        const height = parseNum(row.querySelector('.pkg-height')?.value);
        const gross_weight = parseNum(row.querySelector('.pkg-gw')?.value);

        return { type, length, width, height, gross_weight, unit_system: currentUnitSystem };
      }).filter(p =>
        p.type || [p.length, p.width, p.height, p.gross_weight].some(v => v !== null)
      );

      hidden.value = data.length ? JSON.stringify(data) : '';
    }

    function initPackagesSection() {
      const tbody = document.getElementById('packagesBody');
      const addBtn = document.getElementById('addPackageBtn');
      const unitToggle = document.getElementById('unitToggle');

      if (!tbody) return;

      // remove button handler (delegation)
      tbody.addEventListener('click', function (e) {
        if (e.target && e.target.matches('.btn-remove-pkg')) {
          const tr = e.target.closest('tr');
          if (tr) tr.remove();
        }
      });

      if (addBtn) {
        addBtn.addEventListener('click', function () {
          addPackageRow();
        });
      }

      // Default UI to metric (DB stored cm/kg)
      if (unitToggle) {
        unitToggle.checked = false;
        currentUnitSystem = 'metric';
        unitToggle.addEventListener('change', function () {
          currentUnitSystem = this.checked ? 'imperial' : 'metric';
          updateUnitLabels();
        });
      }

      updateUnitLabels();

      // âœ… hydrate only if JSON has rows; otherwise keep server template rows
      hydratePackagesFromJSONIfAny();

      // Ensure hidden field is populated on load
      serializePackages();
    }

    // -------------------------
    // Bootstrap validation + serialize before submit
    // -------------------------
    function initFormHandlers() {
      const forms = document.querySelectorAll('.needs-validation');
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
          serializePackages();

          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    }

    // -------------------------
    // DOM Ready
    // -------------------------
    document.addEventListener('DOMContentLoaded', function () {
      upperize(document.getElementById('tracking_no'));
      upperize(document.getElementById('declaration_c_number'));
      upperize(document.getElementById('declaration_a_number'));

      initSelect2();
      initPackagesSection();
      initFormHandlers();
    });

    window._serializePackages = serializePackages;

  })();
</script>

{% endblock %}