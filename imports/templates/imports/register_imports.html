{# imports/templates/imports/register_imports.html #}
{% extends 'core/base.html' %}
{% block title %}{% if import_obj %}Edit Import {{ import_obj.import_code }}{% else %}Register Import{% endif %}{% endblock %}

{% block content %}
<style>
  .section { border: 1px solid rgba(0,0,0,.08); border-radius: .6rem; padding: 1rem; margin-bottom: 1rem; }
  .section-title { font-size: .8rem; text-transform: uppercase; letter-spacing: .06em; color: #6c757d; margin-bottom: .75rem; }
  .sticky-actions { position: sticky; bottom: -1px; background: #fff; border-top: 1px solid rgba(0,0,0,.08); padding: .75rem 1rem; z-index: 2; }
  .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,.06); }
  .muted { color: #6c757d; }
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container py-4">
  <div class="card border-0 card-shadow mx-auto" style="max-width: 900px;">
    <div class="card-header bg-white border-0 pt-3 pb-0">
      <h1 class="h4 mb-1">
        {% if import_obj %}
          Edit Import {{ import_obj.import_code }}
        {% else %}
          Register Import
        {% endif %}
      </h1>
      <p class="muted small mb-3">
        Enter shipment and commercial details to {% if import_obj %}update{% else %}create{% endif %} an import record.
      </p>
    </div>

    <div class="card-body pt-3">
      {% if created_import %}
        <div class="alert alert-success mb-3" role="alert">
          Import <strong>{{ created_import.import_code }}</strong> was created successfully.
        </div>
      {% endif %}

      {% with fd=form_data %}
      <form method="post" class="needs-validation" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" id="form_action" value="save_import">

        {# IMPORTANT: keep lines_json exactly as sent back from the view #}
        <input type="hidden"
               name="lines_json"
               id="lines_json"
               value="{{ lines_json|default:''|escape }}">

        <input type="hidden" name="packages_json" id="packages_json">

        {# ðŸ”¹ SECTIONS AS PARTIALS #}
        {% include "imports/partials/basic_details.html" %}
        {% include "imports/partials/financials.html" %}
        {% include "imports/partials/logistics.html" %}
        {% include "imports/partials/import_lines.html" %}
        {% include "imports/partials/weight_dimensions.html" %}
        {% include "imports/partials/charges.html" %}
        {% include "imports/partials/customs_declaration.html" %}
        {% include "imports/partials/notes.html" %}
        {% include "imports/partials/sticky_actions.html" %}
      </form>
      {% endwith %}
    </div>
  </div>
</div>

<script>
  // ---------- Bootstrap validation + serialize packages before submit ----------
  (function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {

        // Before validation, serialize packages into hidden field
        serializePackages();

        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  document.addEventListener('DOMContentLoaded', function () {
    // Uppercase fields
    function upperize(el) {
      if (!el) return;
      el.addEventListener('input', function () {
        const p = this.selectionStart;
        this.value = this.value.toUpperCase();
        try { this.setSelectionRange(p, p); } catch(e) {}
      });
    }
    upperize(document.getElementById('tracking_no'));
    upperize(document.getElementById('declaration_c_number'));
    upperize(document.getElementById('declaration_a_number'));

    // Select2 init...
    const $vendor = $('#vendor_name');
    if ($vendor.length) {
      $vendor.select2({
        width: '100%',
        placeholder: 'Select vendor',
        allowClear: true
      });
      $vendor.on('change', function () {
        this.setCustomValidity(this.value ? '' : ' ');
      });
    }

    const $country = $('#id_exporter_country');
    if ($country.length) {
      $country.select2({
        width: '100%',
        placeholder: 'Exporter Country',
        allowClear: true
      });
    }

    // ðŸ”¹ Initialize packages section
    initPackagesSection();
  });

  // --- Packages JS ---
  let currentUnitSystem = 'metric'; // 'metric' = cm/kg, 'imperial' = in/lbs

  function initPackagesSection() {
    const addBtn = document.getElementById('addPackageBtn');
    const unitToggle = document.getElementById('unitToggle');

    if (addBtn) {
      addBtn.addEventListener('click', function () {
        addPackageRow();
      });
    }

    // Attach remove handler for the initial row rendered by template
    const existingRows = document.querySelectorAll('#packagesBody tr');
    existingRows.forEach(tr => attachRemoveHandler(tr));

    if (unitToggle) {
      unitToggle.addEventListener('change', function () {
        currentUnitSystem = this.checked ? 'imperial' : 'metric';
        updateUnitLabels();
      });
    }
    updateUnitLabels();
  }

  function updateUnitLabels() {
    const unitLabel = document.getElementById('unitLabel');
    const lenLabels = document.querySelectorAll('.len-label');
    const widLabels = document.querySelectorAll('.wid-label');
    const heiLabels = document.querySelectorAll('.hei-label');
    const gwLabels  = document.querySelectorAll('.gw-label');

    if (currentUnitSystem === 'imperial') {
      if (unitLabel) unitLabel.textContent = 'in / lbs';
      lenLabels.forEach(l => l.textContent = 'Length (in)');
      widLabels.forEach(l => l.textContent = 'Width (in)');
      heiLabels.forEach(l => l.textContent = 'Height (in)');
      gwLabels.forEach(l  => l.textContent = 'Gross Weight (lbs)');
    } else {
      if (unitLabel) unitLabel.textContent = 'cm / kg';
      lenLabels.forEach(l => l.textContent = 'Length (cm)');
      widLabels.forEach(l => l.textContent = 'Width (cm)');
      heiLabels.forEach(l => l.textContent = 'Height (cm)');
      gwLabels.forEach(l  => l.textContent = 'Gross Weight (kg)');
    }
  }

  function addPackageRow() {
    const tbody = document.getElementById('packagesBody');
    if (!tbody) return;

    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm pkg-type">
          <option value=""></option>
          <option value="BOX">Box</option>
          <option value="PALLET">Pallet</option>
          <option value="SKID">Skid</option>
          <option value="ROLL">Roll</option>
          <option value="ENVELOPE">Envelope</option>
        </select>
      </td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-length" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-width" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-height" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-gw" placeholder=""></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-pkg">&times;</button>
      </td>
    `;

    tbody.appendChild(tr);
    attachRemoveHandler(tr);
  }

  function attachRemoveHandler(tr) {
    const removeBtn = tr.querySelector('.btn-remove-pkg');
    if (!removeBtn) return;
    removeBtn.addEventListener('click', function () {
      tr.remove();
    });
  }

  function serializePackages() {
    const tbody = document.getElementById('packagesBody');
    const hidden = document.getElementById('packages_json');
    if (!tbody || !hidden) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    const data = rows.map(row => {
      return {
        type:        row.querySelector('.pkg-type')?.value || '',
        length:      row.querySelector('.pkg-length')?.value || '',
        width:       row.querySelector('.pkg-width')?.value || '',
        height:      row.querySelector('.pkg-height')?.value || '',
        gross_weight:row.querySelector('.pkg-gw')?.value || '',
        unit_system: currentUnitSystem
      };
    }).filter(p =>
      p.type || p.length || p.width || p.height || p.gross_weight
    );

    hidden.value = data.length ? JSON.stringify(data) : '';
  }
</script>

{% endblock %}
