{% extends 'core/base.html' %}
{% block title %}Imports{% endblock %}

{% block content %}
<style>
  body { font-size: 0.88rem; }

  .page-wrapper { min-height: 100vh; }

  /* Wider table & darker row separator */
  .table tbody tr { border-bottom: 2px solid #bcbcbc !important; }

  /* Full-width dashboard card */
  .card-outer {
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 60px;
    width: 100%;
    max-width: 1400px;
  }

  .card-body {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }

  .table thead th {
    white-space: nowrap;
    font-size: 0.82rem;
  }

  .table td {
    font-size: 0.84rem;
    vertical-align: middle;
  }

  .table-sticky thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--bs-table-bg, #fff);
    border-bottom: 1px solid var(--bs-border-color);
  }

  .badge-pill {
    border-radius: 10rem;
    font-size: 0.72rem;
  }

  .table-compact .table td,
  .table-compact .table th {
    padding-top: .35rem;
    padding-bottom: .35rem;
  }

  .table-hover tbody tr:hover {
    background: rgba(0,0,0,.02);
    transition: background 0.2s;
  }

  .text-muted.small { font-size: 0.78rem; }

  form .form-label { font-size: 0.8rem; }

  .row-highlight { background-color: #eafaf0 !important; }

  .col-actions { width: 120px; }

  /* ‚úÖ DATE COLUMNS: fixed width + no wrap (ONLY dates) */
  th.col-decl-date, td.col-decl-date,
  th.col-expected,  td.col-expected,
  th.col-created,   td.col-created {
    white-space: nowrap;
    width: 115px;
    min-width: 110px;
    text-align: center;
  }

  @media (max-width: 575.98px) {
    .col-expected { display: none; }
  }

  @media (max-width: 767.98px) {
    .col-incoterms, .col-created { display: none; }
  }

  .pagination-fixed-bottom {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1030;
    background: #fff;
    border-top: 1px solid #dee2e6;
    padding: .25rem 1rem .35rem;
  }

  #fixedScroller {
    overflow-x: auto;
    overflow-y: hidden;
    height: 16px;
    margin-bottom: 4px;
  }

  #fakeScroll { height: 1px; }

  .lines-row { background-color: #fcfcfc; }

  .lines-row table td,
  .lines-row table th { font-size: 0.78rem; }

  .btn-link.toggle-lines { text-decoration: none; }

  .btn-link.toggle-lines::after {
    content: " ‚ñæ";
    font-size: 0.75rem;
  }

  .btn-link.toggle-lines.open::after { content: " ‚ñ¥"; }

  .status-dropdown-menu {
    min-width: 220px;
    max-height: 260px;
    overflow-y: auto;
  }
</style>

<div class="page-wrapper">
  <div class="card mx-auto shadow-sm border-0 card-outer">
    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h1 class="h5 mb-1">Imports</h1>
        <div class="text-muted small">Browse and manage registered imports</div>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-outline-success btn-sm"
           href="{% url 'imports_payments_excel' %}?q={{ q }}{% for s in status_selected %}&status={{ s }}{% endfor %}{% for m in method_selected %}&method={{ m }}{% endfor %}">
          Payments
        </a>

        <a class="btn btn-sm btn-outline-secondary" href="{% url 'imports_export' %}">
          Download Imports
        </a>

        <a href="{% url 'imports_export_lines_excel' %}"
           class="btn btn-sm btn-outline-secondary ms-2">
          Download lines
        </a>

        <a class="btn btn-sm btn-primary" href="{% url 'imports_register' %}">Register Import</a>

        <a class="btn btn-sm btn-outline-dark" href="{% url 'home' %}">
          ‚¨ÖÔ∏è Back
        </a>
      </div>
    </div>

    <div class="card-body pt-3">
      <!-- Filters / Search -->
      <form id="importsFilterForm" method="get" class="row gx-3 gy-2 align-items-end mb-3">
        <div class="col-md-5">
          <label class="form-label mb-1">Search</label>
          <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
                 placeholder="Import code, vendor, tracking, references‚Ä¶">
        </div>

        {# üîπ STATUS FILTER: dropdown with checkboxes + ALL #}
        <div class="col-md-3">
          <label class="form-label mb-1">Status</label>
          <div class="dropdown w-100">
            <button class="btn btn-sm btn-outline-secondary w-100 text-start"
                    type="button"
                    id="statusDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span id="statusDropdownLabel">
                {% if status_f %}
                  {{ status_f|join:", " }}
                {% else %}
                  All statuses
                {% endif %}
              </span>
            </button>

            <div class="dropdown-menu p-2 status-dropdown-menu"
                 aria-labelledby="statusDropdown">
              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox"
                       id="status_all"
                       {% if not status_f %}checked{% endif %}>
                <label class="form-check-label small" for="status_all">All</label>
              </div>
              <hr class="my-1">

              {% for s in STATUS_CHOICES %}
                <div class="form-check mb-1">
                  <input class="form-check-input status-checkbox"
                         type="checkbox"
                         value="{{ s }}"
                         id="status_{{ forloop.counter }}"
                         {% if s in status_f %}checked{% endif %}>
                  <label class="form-check-label small" for="status_{{ forloop.counter }}">
                    {{ s|title }}
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>
          <div id="statusHiddenInputs"></div>
        </div>

        {# üîπ METHOD FILTER: dropdown with checkboxes + ALL #}
        <div class="col-md-3">
          <label class="form-label mb-1">Method</label>
          <div class="dropdown w-100">
            <button class="btn btn-sm btn-outline-secondary w-100 text-start"
                    type="button"
                    id="methodDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span id="methodDropdownLabel">
                {% if method_f %}
                  {{ method_f|join:", " }}
                {% else %}
                  All methods
                {% endif %}
              </span>
            </button>

            <div class="dropdown-menu p-2 status-dropdown-menu"
                 aria-labelledby="methodDropdown">
              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox"
                       id="method_all"
                       {% if not method_f %}checked{% endif %}>
                <label class="form-check-label small" for="method_all">All</label>
              </div>
              <hr class="my-1">

              {% for m in METHOD_CHOICES %}
                <div class="form-check mb-1">
                  <input class="form-check-input method-checkbox"
                         type="checkbox"
                         value="{{ m }}"
                         id="method_{{ forloop.counter }}"
                         {% if m in method_f %}checked{% endif %}>
                  <label class="form-check-label small" for="method_{{ forloop.counter }}">
                    {{ m|title }}
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>
          <div id="methodHiddenInputs"></div>
        </div>

        <div class="col-md-1 d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm w-100" type="submit">Apply</button>
        </div>
      </form>

      <!-- Table -->
      <div class="table-responsive table-sticky table-compact" id="tableWrap">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Code</th>
              <th>Vendor</th>
              <th>Country</th>
              <th>Tracking</th>
              <th class="col-incoterms">Incoterms</th>
              <th>Method</th>
              <th>Status</th>
              <th>Forwarder</th>
              <th>Decl. C No.</th>
              <th class="col-decl-date">Decl. Date</th>
              <th class="col-expected">Expected</th>
              <th class="col-created">Created</th>
              {% if user.is_superuser %}
                <th class="text-end col-actions">Actions</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% if page_obj.object_list %}
              {% for imp in page_obj %}
                {# MAIN ROW #}
                <tr class="{% if imp.declaration_a_number %}row-highlight{% endif %}">
                  <td class="fw-semibold text-nowrap">
                    <button type="button"
                            class="btn btn-link p-0 toggle-lines"
                            data-import-id="{{ imp.id }}">
                      {{ imp.import_code }}
                    </button>
                  </td>

                  <td>{{ imp.vendor_name|default:"‚Äî" }}</td>
                  <td>{{ imp.exporter_country|default:"‚Äî" }}</td>
                  <td>{{ imp.tracking_no|default:"‚Äî" }}</td>
                  <td class="col-incoterms">{{ imp.incoterms|default:"‚Äî" }}</td>

                  <td>
                    {% if imp.shipping_method %}
                      {% with m=imp.shipping_method %}
                        {% if m == "AIR" %}
                          <span class="badge bg-info-subtle text-info border badge-pill">Air</span>
                        {% elif m == "SEA" %}
                          <span class="badge bg-primary-subtle text-primary border badge-pill">Sea</span>
                        {% elif m == "ROAD" %}
                          <span class="badge bg-success-subtle text-success border badge-pill">Road</span>
                        {% elif m == "COURIER" %}
                          <span class="badge bg-warning-subtle text-warning border badge-pill">Courier</span>
                        {% elif m == "OTHER" %}
                          <span class="badge bg-secondary-subtle text-secondary border badge-pill">Other</span>
                        {% else %}
                          <span class="badge bg-light border text-muted badge-pill">{{ m|title }}</span>
                        {% endif %}
                      {% endwith %}
                    {% else %}‚Äî{% endif %}
                  </td>

                  <td>
                    {% if imp.shipment_status %}
                      {% with s=imp.shipment_status %}
                        {% if s == "DELIVERED" %}
                          <span class="badge bg-success-subtle text-success border badge-pill">Delivered</span>
                        {% elif s == "AT_CUSTOMS" %}
                          <span class="badge bg-warning-subtle text-warning border badge-pill">At customs</span>
                        {% elif s == "IN_TRANSIT" %}
                          <span class="badge bg-info-subtle text-info border badge-pill">In transit</span>
                        {% elif s == "PICKED_UP" %}
                          <span class="badge bg-primary-subtle text-primary border badge-pill">Picked up</span>
                        {% elif s == "CANCELLED" %}
                          <span class="badge bg-danger-subtle text-danger border badge-pill">Cancelled</span>
                        {% else %}
                          <span class="badge bg-light border text-muted badge-pill">{{ s|title }}</span>
                        {% endif %}
                      {% endwith %}
                    {% else %}‚Äî{% endif %}
                  </td>

                  <td>
                    {% if imp.forwarder %}
                      {{ imp.forwarder.name }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>

                  <td>{{ imp.declaration_c_number|default:"‚Äî" }}</td>

                  <td class="col-decl-date">
                    {% if imp.declaration_date %}
                      {{ imp.declaration_date|date:"Y-m-d" }}
                    {% else %}‚Äî{% endif %}
                  </td>

                  <td class="col-expected">
                    {% if imp.expected_receipt_date %}
                      {{ imp.expected_receipt_date|date:"Y-m-d" }}
                    {% else %}‚Äî{% endif %}
                  </td>

                  <td class="col-created">
                    {{ imp.created_at|date:"Y-m-d" }}
                  </td>

                  {% if user.is_superuser %}
                    <td class="text-end col-actions">
                      <a href="{% url 'import_single_excel' imp.pk %}"
                         class="btn btn-sm btn-outline-success mb-1">üì•</a>

                      <a href="{% url 'imports_edit' imp.pk %}"
                         class="btn btn-sm btn-outline-primary mb-1">‚úé</a>

                      <a href="{% url 'imports_delete_confirm' imp.pk %}"
                         class="btn btn-sm btn-outline-danger"
                         onclick="return confirm('Proceed to delete {{ imp.import_code }}?');">üóë</a>
                    </td>
                  {% endif %}
                </tr>

                {# DETAIL ROW WITH LINES TABLE #}
                <tr class="lines-row d-none" data-import-id="{{ imp.id }}">
                  <td colspan="{% if user.is_superuser %}13{% else %}12{% endif %}">
                    {% if imp.lines.exists %}
                      <div class="table-responsive mt-2 mb-2">
                        <table class="table table-sm table-bordered mb-0">
                          <thead class="table-light">
                            <tr>
                              <th>Document No.</th>
                              <th>Line No.</th>
                              <th>Item No.</th>
                              <th>Description</th>
                              <th>Quantity</th>
                              <th>Unit of Measure</th>
                              <th>Unit Cost</th>
                              <th>Line Amount</th>
                              <th>Goods Currency</th>
                              <th>Expected Receipt Date</th>
                              <th>Delivery Date</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for line in imp.lines.all %}
                              <tr>
                                <td>{{ line.document_no|default:"" }}</td>
                                <td>{{ line.line_no|default:"" }}</td>
                                <td>{{ line.item_no|default:"" }}</td>
                                <td>{{ line.description|default:"" }}</td>
                                <td>{% if line.quantity is not None %}{{ line.quantity }}{% endif %}</td>
                                <td>{{ line.unit_of_measure|default:"" }}</td>
                                <td>{% if line.unit_cost is not None %}{{ line.unit_cost }}{% endif %}</td>
                                <td>{% if line.line_amount is not None %}{{ line.line_amount }}{% endif %}</td>
                                <td>{{ imp.currency_code|default:"" }}</td>
                                <td>{% if line.expected_receipt_date %}{{ line.expected_receipt_date|date:"Y-m-d" }}{% endif %}</td>
                                <td>{% if line.delivery_date %}{{ line.delivery_date|date:"Y-m-d" }}{% endif %}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% else %}
                      <div class="text-muted small mt-1 mb-1">
                        No lines for this import.
                      </div>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{% if user.is_superuser %}13{% else %}12{% endif %}"
                    class="text-center text-muted py-4">
                  No imports found.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if page_obj.paginator.num_pages > 1 %}
  <div class="pagination-fixed-bottom">
    <div id="fixedScroller"><div id="fakeScroll"></div></div>

    <nav aria-label="Imports pagination">
      <ul class="pagination pagination-sm justify-content-end mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?q={{ q }}{% if status_qs %}&{{ status_qs }}{% endif %}{% if method_qs %}&{{ method_qs }}{% endif %}&page={{ page_obj.previous_page_number }}">
              Prev
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Prev</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?q={{ q }}{% if status_qs %}&{{ status_qs }}{% endif %}{% if method_qs %}&{{ method_qs }}{% endif %}&page={{ page_obj.next_page_number }}">
              Next
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tableWrap = document.getElementById('tableWrap');
    const fixedScroller = document.getElementById('fixedScroller');
    const fakeScroll = document.getElementById('fakeScroll');

    if (tableWrap && fixedScroller && fakeScroll) {
      function updateWidth() {
        fakeScroll.style.width = tableWrap.scrollWidth + 'px';
      }
      updateWidth();
      window.addEventListener('resize', updateWidth);

      fixedScroller.addEventListener('scroll', function () {
        tableWrap.scrollLeft = fixedScroller.scrollLeft;
      });

      tableWrap.addEventListener('scroll', function () {
        fixedScroller.scrollLeft = tableWrap.scrollLeft;
      });
    }

    // üîΩ TOGGLE IMPORT LINES
    document.querySelectorAll('.toggle-lines').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const importId = this.getAttribute('data-import-id');
        const detailRow = document.querySelector('.lines-row[data-import-id="' + importId + '"]');
        if (!detailRow) return;
        detailRow.classList.toggle('d-none');
        this.classList.toggle('open');
      });
    });

    const filterForm = document.getElementById('importsFilterForm');

    // üîπ STATUS CHECKBOX LOGIC + HIDDEN INPUTS
    const statusAllCheckbox = document.getElementById('status_all');
    const statusCheckboxes = document.querySelectorAll('.status-checkbox');
    const statusHiddenContainer = document.getElementById('statusHiddenInputs');
    const statusLabel = document.getElementById('statusDropdownLabel');

    function updateStatusHiddenInputs() {
      if (!statusHiddenContainer) return;
      statusHiddenContainer.innerHTML = '';
      const checked = Array.from(statusCheckboxes).filter(cb => cb.checked);

      checked.forEach(cb => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'status';
        input.value = cb.value;
        statusHiddenContainer.appendChild(input);
      });

      if (checked.length === 0) {
        statusLabel.textContent = 'All statuses';
        if (statusAllCheckbox) statusAllCheckbox.checked = true;
      } else {
        const values = checked.map(cb => cb.value);
        statusLabel.textContent = values.join(', ');
        if (statusAllCheckbox) statusAllCheckbox.checked = false;
      }
    }

    if (statusAllCheckbox) {
      statusAllCheckbox.addEventListener('change', function () {
        if (this.checked) {
          statusCheckboxes.forEach(cb => cb.checked = false);
          updateStatusHiddenInputs();
        }
      });
    }

    statusCheckboxes.forEach(cb => {
      cb.addEventListener('change', function () {
        if (statusAllCheckbox && this.checked) statusAllCheckbox.checked = false;
        updateStatusHiddenInputs();
      });
    });

    // üîπ METHOD CHECKBOX LOGIC + HIDDEN INPUTS
    const methodAllCheckbox = document.getElementById('method_all');
    const methodCheckboxes = document.querySelectorAll('.method-checkbox');
    const methodHiddenContainer = document.getElementById('methodHiddenInputs');
    const methodLabel = document.getElementById('methodDropdownLabel');

    function updateMethodHiddenInputs() {
      if (!methodHiddenContainer) return;
      methodHiddenContainer.innerHTML = '';
      const checked = Array.from(methodCheckboxes).filter(cb => cb.checked);

      checked.forEach(cb => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'method';
        input.value = cb.value;
        methodHiddenContainer.appendChild(input);
      });

      if (checked.length === 0) {
        methodLabel.textContent = 'All methods';
        if (methodAllCheckbox) methodAllCheckbox.checked = true;
      } else {
        const values = checked.map(cb => cb.value);
        methodLabel.textContent = values.join(', ');
        if (methodAllCheckbox) methodAllCheckbox.checked = false;
      }
    }

    if (methodAllCheckbox) {
      methodAllCheckbox.addEventListener('change', function () {
        if (this.checked) {
          methodCheckboxes.forEach(cb => cb.checked = false);
          updateMethodHiddenInputs();
        }
      });
    }

    methodCheckboxes.forEach(cb => {
      cb.addEventListener('change', function () {
        if (methodAllCheckbox && this.checked) methodAllCheckbox.checked = false;
        updateMethodHiddenInputs();
      });
    });

    if (filterForm) {
      filterForm.addEventListener('submit', function () {
        updateStatusHiddenInputs();
        updateMethodHiddenInputs();
      });
    }

    // initial sync on page load (for pre-selected filters)
    updateStatusHiddenInputs();
    updateMethodHiddenInputs();
  });
</script>

{% endblock %}
