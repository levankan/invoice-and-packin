{# imports/templates/imports/partials/weight_dimensions.html #}
<div class="section">
  <div class="section-title d-flex justify-content-between align-items-center">
    <span>Weight &amp; Dimensions</span>
    <div class="d-flex align-items-center gap-2">
      <small class="text-muted me-1" id="unitLabel">cm / kg</small>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="unitToggle">
        <label class="form-check-label small" for="unitToggle">in / lbs</label>
      </div>
    </div>
  </div>

  <div class="table-responsive small">
    <table class="table align-middle mb-2">
      <thead class="table-light">
        <tr>
          <th style="width: 18%;">Package Type</th>
          <th style="width: 15%;"><span class="len-label">Length (cm)</span></th>
          <th style="width: 15%;"><span class="wid-label">Width (cm)</span></th>
          <th style="width: 15%;"><span class="hei-label">Height (cm)</span></th>
          <th style="width: 15%;"><span class="gw-label">Gross Weight (kg)</span></th>
          <th style="width: 10%;"></th>
        </tr>
      </thead>
      <tbody id="packagesBody">
        {# ðŸ”¹ One default row so inputs are always visible #}
        <tr>
          <td>
            <select class="form-select form-select-sm pkg-type">
              <option value=""></option>
              <option value="BOX">Box</option>
              <option value="PALLET">Pallet</option>
              <option value="SKID">Skid</option>
              <option value="ROLL">Roll</option>
              <option value="ENVELOPE">Envelope</option>
            </select>
          </td>
          <td><input type="number" step="0.01" class="form-control form-control-sm pkg-length" placeholder=""></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm pkg-width" placeholder=""></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm pkg-height" placeholder=""></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm pkg-gw" placeholder=""></td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-pkg">&times;</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <button type="button" class="btn btn-sm btn-outline-primary" id="addPackageBtn">
    + Add package
  </button>

  {% if import_obj %}
    <div class="row g-3 mt-3">
      <div class="col-md-4">
        <div class="form-floating">
          <input type="text"
                 class="form-control"
                 id="total_gw"
                 value="{{ import_obj.total_gross_weight_kg }}"
                 readonly>
          <label for="total_gw">Total Gross Weight (kg)</label>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-floating">
          <input type="text"
                 class="form-control"
                 id="total_vw"
                 value="{{ import_obj.total_volumetric_weight_kg }}"
                 readonly>
          <label for="total_vw">Total Volumetric Weight (kg)</label>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
  // --- Packages JS, used by register_imports.html ---
  let currentUnitSystem = 'metric'; // 'metric' = cm/kg, 'imperial' = in/lbs

  function initPackagesSection() {
    const addBtn = document.getElementById('addPackageBtn');
    const unitToggle = document.getElementById('unitToggle');

    if (addBtn) {
      addBtn.addEventListener('click', function () {
        addPackageRow();
      });
    }

    // Attach remove handler for the initial row rendered by template
    const existingRows = document.querySelectorAll('#packagesBody tr');
    existingRows.forEach(tr => attachRemoveHandler(tr));

    if (unitToggle) {
      unitToggle.addEventListener('change', function () {
        currentUnitSystem = this.checked ? 'imperial' : 'metric';
        updateUnitLabels();
      });
    }
    updateUnitLabels();
  }

  function updateUnitLabels() {
    const unitLabel = document.getElementById('unitLabel');
    const lenLabels = document.querySelectorAll('.len-label');
    const widLabels = document.querySelectorAll('.wid-label');
    const heiLabels = document.querySelectorAll('.hei-label');
    const gwLabels  = document.querySelectorAll('.gw-label');

    if (currentUnitSystem === 'imperial') {
      if (unitLabel) unitLabel.textContent = 'in / lbs';
      lenLabels.forEach(l => l.textContent = 'Length (in)');
      widLabels.forEach(l => l.textContent = 'Width (in)');
      heiLabels.forEach(l => l.textContent = 'Height (in)');
      gwLabels.forEach(l  => l.textContent = 'Gross Weight (lbs)');
    } else {
      if (unitLabel) unitLabel.textContent = 'cm / kg';
      lenLabels.forEach(l => l.textContent = 'Length (cm)');
      widLabels.forEach(l => l.textContent = 'Width (cm)');
      heiLabels.forEach(l => l.textContent = 'Height (cm)');
      gwLabels.forEach(l  => l.textContent = 'Gross Weight (kg)');
    }
  }

  function addPackageRow() {
    const tbody = document.getElementById('packagesBody');
    if (!tbody) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm pkg-type">
          <option value=""></option>
          <option value="BOX">Box</option>
          <option value="PALLET">Pallet</option>
          <option value="SKID">Skid</option>
          <option value="ROLL">Roll</option>
          <option value="ENVELOPE">Envelope</option>
        </select>
      </td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-length" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-width" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-height" placeholder=""></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm pkg-gw" placeholder=""></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-pkg">&times;</button>
      </td>
    `;
    tbody.appendChild(tr);
    attachRemoveHandler(tr);
  }

  function attachRemoveHandler(tr) {
    const removeBtn = tr.querySelector('.btn-remove-pkg');
    if (!removeBtn) return;
    removeBtn.addEventListener('click', function () {
      tr.remove();
    });
  }

  function serializePackages() {
    const tbody = document.getElementById('packagesBody');
    const hidden = document.getElementById('packages_json');
    if (!tbody || !hidden) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    const data = rows.map(row => {
      return {
        type:        row.querySelector('.pkg-type')?.value || '',
        length:      row.querySelector('.pkg-length')?.value || '',
        width:       row.querySelector('.pkg-width')?.value || '',
        height:      row.querySelector('.pkg-height')?.value || '',
        gross_weight:row.querySelector('.pkg-gw')?.value || '',
        unit_system: currentUnitSystem
      };
    }).filter(p =>
      p.type || p.length || p.width || p.height || p.gross_weight
    );

    hidden.value = data.length ? JSON.stringify(data) : '';
  }
</script>
